<?xml version="1.0" encoding="UTF-8"?>
<workflow-app xmlns:ssh="uri:oozie:ssh-action:0.2" xmlns:shell="uri:oozie:shell-action:0.3" xmlns="uri:oozie:workflow:0.5" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" name="[[workflowName]]">
	<parameters>
		<property>
			<name>BDAP_LIB</name>
			<value>${nameNode}/bdap-VVERSIONN/engine/lib</value>
		</property>
		<property>
			<name>APP_LIB</name>
			<value>${nameNode}${prjFolder}${wfName}/lib</value>
		</property>
		<property>
			<name>BDAP_LIB_JARS</name>
			<value>${engineJars}</value>
		</property>
	</parameters>
	<global>
		<configuration>
			<property>
				<name>oozie.launcher.yarn.app.mapreduce.am.env</name>
				<value>SPARK_HOME=[[sparkhome]]</value>
			</property>
		</configuration>
	</global>
	<start to="SparkProcess"/>
	<kill name="fail">
		<message>Java failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
	</kill>
	<action name="SparkProcess">
		<shell xmlns="uri:oozie:shell-action:0.2">
            <job-tracker>${jobTracker}</job-tracker>
            <name-node>${nameNode}</name-node>
            <exec>submitspark.sh</exec>
            <argument>--class</argument>
            <argument>etl.engine.ETLCmdMain</argument>
            <argument>--master</argument>
            <argument>yarn</argument>
            <argument>--deploy-mode</argument>
            <argument>cluster</argument>
            <argument>--executor-memory</argument>
            <argument>7G</argument>
            <argument>--total-executor-cores</argument>
            <argument>7</argument>
            <argument>--conf</argument>
            <argument>spark.yarn.historyServer.address=[[sparkhistoryserver]]</argument>
            <argument>--conf</argument>
            <argument>spark.eventLog.dir=[[defaultfs]]/spark/logs</argument>
            <argument>--conf</argument>
            <argument>spark.eventLog.enabled=true</argument>
            
            <argument>--jars</argument>
            <argument>${BDAP_LIB_JARS},${APP_LIB}/${wfName}.jar[[thirdpartyjars]]</argument>
            <argument>${BDAP_LIB}/bdap.engine-VVERSIONN.jar</argument>
            <argument>${cmdClassName}</argument>
            <argument>${wfName}</argument>
            <argument>${wf:id()}</argument>
            <argument>action.spark.properties</argument>
            <argument>${nameNode}</argument>
        </shell>
		<ok to="end"/>
		<error to="fail"/>
	</action>
	<end name="end"/>
</workflow-app>
